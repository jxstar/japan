---
title: "JP tourists Number Prediction 201507"
author: "小新"
date: "2015年8月4日"
output: html_document
---



# 1 总体情况

## 1.1 关键方法和结果

1.  采用了六种方法预测：

    ＋ 基于Y2Y增长绝对数值的线性回归预测
    
    ＋ 基于Y2Y增长绝对数值的一阶差分预测
    
    ＋ 基于M2M月度一阶差分的线性回归预测
    
    ＋ 基于M2M月度一阶差分的保守预测
    
    ＋ 基于M2M月度二阶差分预测
    
    ＋ 基于百度指数的线性回归预测

2.  主要问题：仍然找不到很合适的百度指数
    
3.  请交叉验证

4.  自动报告文档，格式还不完善。

## 1.2 关键参数 

1.  仿真输入：日本购物攻略 的百度指数以及新年哑变量、MARS哑变量

2.  学习时间：2014年1月－2015年6月

3.  仿真结果：62万人左右

# 2 仿真过程

## 2.1 Overview

+ 总的方法分为三个维度

    +  Y2Y增长量在2015M1至M6中的相关性规律（Diff12 groupby month）

    +  M2M增长量在2008至2015年中的相关性规律（Diff1 groupby year）

    +  百度指数：在最近1-2年中与日本旅游人数的相关性规律

```{r, echo=FALSE,results='hide',message=FALSE,warning=FALSE, cache=F}

library(quantmod)
library(leaps)
library(Hmisc) #describe
library(psych) #describe
library(GPArotation)
library(pastecs) #stat.desc
library(corrgram) # for corralation analysis
library(gvlma)
library(car)
library(relaimpo)

library(xlsx)
library(RSQLite)
library(RMySQL)

library(ggplot2) #add for ggplot
library(reshape2)
library(dplyr)


##deal with CSV file
##1. delete the "," in number
##2. change the date to 
par(mfrow=c(1,1))
mycolor=rainbow(20)


## Global constant
target.time=as.POSIXlt("2015-07-01")
target.mon=target.time$mon+1
target.year=target.time$year+1900


#=================================================================================================
#1# read the data

#1.1 official JP arrival data and the currency-----------------------------jp
if (F){
  japan=read.csv("japan.csv",header=T,na.strings="",stringsAsFactor=F)
  names(japan)=c("date","bi","arrival","csi")
  japan$date=as.Date(japan$date,"%m/%d/%y")
  japan$bi=as.numeric(japan$bi)
  japan$arrival=as.numeric(japan$arrival)
}



japan=read.xlsx("japan.tourists.number.xlsx",1)
japan$arrival1 = c(NA, japan$arrival[1:(nrow(japan)-1)]);
japan$arrival12 = c(rep(NA, 12), japan$arrival[1:(nrow(japan)-12)]);
#define the one stage differentcial
japan$diff=japan$arrival-japan$arrival1
japan$diff12=japan$arrival-japan$arrival12
japan$mm=japan$arrival/japan$arrival1
japan$yy=japan$arrival/japan$arrival12
japan$year=as.integer(format(as.Date(japan$date),"%Y"))
japan$month=as.integer(format(as.Date(japan$date),"%m"))
jp=japan 
jp=filter(jp,date<=as.Date(target.time))


#=================================================================================================
#2# analysis the datap <- ggplot(jp, aes(month, arrival))

#2.1 overall prosect---------------------------------------------------------
p <- ggplot(jp, aes(month, arrival))
p1 <- p + geom_line(aes(colour = factor(year)), alpha = 0.6,main="test")+
  geom_point(aes(colour = factor(year)))+labs(title="JP History Tourist Number Groupby Year")
print(p1)

p2=p + geom_line(aes(colour = factor(year)), alpha = 0.6)+geom_point(aes(colour = factor(year)))+facet_wrap(~year)+
  labs(title="JP History Tourist Number")
print(p2)



```


##2.2  基于Y2Y增长绝对数值的线性回归预测


```{r, echo=FALSE,results='hide',message=FALSE,warning=FALSE, cache=F}


#=================================================================================================
#3 predict with the Y2Y Trend
#combination

#2003 year is quite special
cmbjp=select(filter(jp,year %in% c(2004:target.year),month %in% c(1:target.mon)),year,month,arrival)
meltjp=melt(cmbjp,id=c("year","month"))

#cast the data as year id and produce m1a2,m34
dmjp=dcast(meltjp,year~month+variable)
names(dmjp)=c("year",paste("m",c(1:target.mon),sep=""))

dmjp$m1a2=(dmjp$m1+dmjp$m2)/2
dmjp$m34=(dmjp$m3+dmjp$m4)/2
dmjp$m45=(dmjp$m5+dmjp$m4)/2
dmjp$m56=(dmjp$m5+dmjp$m6)/2

target.smon=paste("m",target.mon,sep="")

#calculate the Y2Y percentage
dmpjp=dmjp
dmpjp[2:nrow(dmpjp),2:ncol(dmpjp)]=dmjp[2:nrow(dmjp),2:ncol(dmjp)]-dmjp[1:nrow(dmjp)-1,2:ncol(dmjp)]
dmpjp[1,2:ncol(dmpjp)]=0

#apply(dmpjp[,c(6,7)],1,order)

#m56 is the best, m6 is also OK
hcor=cor(dmpjp[-nrow(dmpjp),which(names(dmpjp)==target.smon)],dmpjp[-nrow(dmpjp),-1]) 
#vcor no year is quite correlated
vcor=cor(t(dmpjp[-which(names(dmpjp)==target.smon)]),t(dmpjp[,-which(names(dmpjp)==target.smon)]))

# predict the year 2 year diff
hcor=cor(dmpjp[-nrow(dmpjp),which(names(dmpjp)==target.smon)],dmpjp[-nrow(dmpjp),-1]) 

#dmpjp.t=dmpjp[-which(dmpjp$year==2015 | dmpjp$year==2008),]
dmpjp.t=filter(dmpjp,year<2015 & year>2008)
dmpjp.p=dmpjp[which(dmpjp$year==2015),]

diff12.fit=lm(m7~m56,dmpjp.t)
#diff12.fit=lm(m7~m6,dmpjp.t)
summary(diff12.fit)
predict(diff12.fit,newdata=dmpjp.p)
dmpjp[which(dmpjp$year==2015),target.smon]=predict(diff12.fit,newdata=dmpjp.p)
dmpjp$prediction=predict(diff12.fit,newdata=dmpjp)
dmpjp$error=(dmpjp$prediction-dmpjp$m7)/dmjp$m7




#dmjp[which(dmjp$year==2015),"m6"]=dmpjp[which(dmpjp$year==2015),"m6"]+dmjp[which(dmjp$year==2014),"m6"]
#predict.result=dmjp[which(dmjp$year==2015),"m6"]
predict.result=dmpjp[which(dmpjp$year==2015),target.smon]+dmjp[which(dmjp$year==2014),"m56"]

range(dmpjp.t$m7-fitted(diff12.fit))

benchmark=data.frame(date=as.Date(target.time),methdology="Y2Y Diff LR with M56",
                     floor=predict.result+range(dmpjp.t$m6-fitted(diff12.fit))[1],
                     cap=predict.result+range(dmpjp.t$m6-fitted(diff12.fit))[2],
                     bestguess=predict.result,stringsAsFactors = F)



```

###2.2.1 直观overview


+  直观上看Diff12 在各个月份之间是存在相关性的，个个月份的变化在最近几年是比较一致。

```{r, echo=FALSE,results='hide',message=FALSE,warning=FALSE, cache=F}
#=================================================================================================
#3 predict with the Y2Y Trend
#combination
p<- ggplot(filter(jp,year %in% c(2002:target.year),month %in% c(1:target.mon)), aes(year, arrival))
p1 <- p + geom_line(aes(colour = factor(month)), alpha = 0.6)+geom_point(aes(colour = factor(month)))+
  labs(title="JP History Tourist Number Groupby Month")
print(p1)

p<- ggplot(filter(jp,year %in% c(2002:target.year),month %in% c(1:target.mon)), aes(year, diff12))
p1 <- p + geom_line(aes(colour = factor(month)), alpha = 0.6)+geom_point(aes(colour = factor(month)))+
  labs(title="JP Y2Y Diff Groupby Month")
print(p1)

```


###2.2.2 相关性分析


+  研究“Y2Y增长额度Diff12（M7）” ，发现Diff12（M7）与Diff12（M56）呈现很强的相关性，高达`r as.data.frame(hcor)[,"m56"]`,因此考虑使用Linear Regression的方法，通过Diff12（M56）来预测Diff12（M7）。

`r knitr::kable(as.data.frame(hcor),caption="Y2Y Diff12（M7）Coefficient Correlation")`


+  下面图1直观展示了二者的线性关系，图2展示了Diff12（M7）结果，图3展示了误差情况

+  呈现强相关的都是在Diff12（M56）低位，因为2015 Diff12（M56）暴增，在高位是否与Diff12（M7）仍然呈现线性关系是个问题

+  因此，本方法相对来说比较“激进”


```{r, echo=FALSE,results='hide',message=FALSE,warning=FALSE, cache=F}

msjp=melt(dmpjp[,c("m7","m56","prediction")],id="m56")
p <- ggplot(msjp, aes(m56, value))
p1 <- p + geom_line(aes(colour = factor(variable)), alpha = 0.6)+geom_point(aes(colour = factor(variable)))+
  labs(title="Y2Y Diff M7 VS M56 to Predict M7")
print(p1)

msjp=melt(dmpjp[,c("year","m7","m56","prediction")],id="year")
p <- ggplot(msjp, aes(year, value))
p1 <- p + geom_line(aes(colour = factor(variable)), alpha = 0.6)+geom_point(aes(colour = factor(variable)))+
  labs(title="Y2Y Diff12 M56 to Predict M7")
print(p1)


(p <- ggplot(data=dmpjp,aes(x=factor(year),weight=error,fill=factor(year))) + 
  geom_bar(position='dodge')+labs(title="Y2Y Linear Regression Error"))


```


###2.2.3 结果

`r knitr::kable(benchmark[1,],caption="基于Y2Y增长绝对数值的线性回归预测")`



    
##2.3  基于Y2Y增长绝对数值的一阶差分预测


```{r, echo=FALSE,results='hide',message=FALSE,warning=FALSE, cache=F}


#=================================================================================================
#4 Y2Y Diff Mean with 1st order different
#-------------------------------------------------------------------------------------------
sjp.data=(dmpjp[,-1]-dmpjp[,which(names(dmpjp)==target.smon)])/dmpjp[,which(names(dmpjp)==target.smon)]
sjp.data[1,]=0
sjp.data=select(sjp.data,-prediction,-error)
#select the best KPI with lowest volatility whichh is sigma--------------------------
sigma=apply(sjp.data,2,function (x) {
  return(var(x,na.rm=T))
})

#here we select m6 with the lowest volatility
sigma=sigma[order(sigma)]


sjp.data=sjp.data[,names(sigma)]
sjp=cbind(year=dmjp$year,sjp.data)
```

###2.3.1  方法论

+  直观上看Diff12（M7）与Diff12（M56）、Diff12（M6）之间是同趋势变化的，本方法旨在找到与Diff12（M7）变化趋势最相近的变量指标。判断标准是最小化：Variance of Diff12（M7）- Diff12（Mxx）。

+  从下图中可以看到，Diff12（M6）和Diff12（M7）的差值是variance波动率几乎是0

+  这是一个非常好的性质，我们可以假定，Diff12（M6）和Diff12（M7）一阶差分在各个年度是不变的。

+  因此，我们用2014年Diff12（M7）- Diff12（M6）作为2015年差值，再加上2015 Diff12 M6可以得到2015 Diff12（M7）


```{r, echo=FALSE,results='hide',message=FALSE,warning=FALSE, cache=F}

(p <- ggplot(data=melt(as.data.frame(t(sigma)),id="m7"),aes(x=factor(variable),weight=value,fill=factor(variable))) + 
  geom_bar(position='dodge')+labs(title="1st Diff12 variance with some variables"))


dmpjp[which(dmpjp$year==2015),target.smon]=NA
msjp=melt(dmpjp[,c("year","m7","m6","m56")],id="year")
p <- ggplot(msjp, aes(year, value))
p1 <- p + geom_line(aes(colour = factor(variable)), alpha = 0.6)+geom_point(aes(colour = factor(variable)))+
  labs(title="JP Diff12 Groupby Month")
print(p1)

ddmpjp=as.data.frame(cbind(year=dmpjp$year, diff=dmpjp[,target.smon]-dmpjp$m6))

# m6: M6 Diff 12
#mean(m6)(without2015)-mean(m45)(without2015)=m6(2015)-m45(2015)
#m6(2015)=mean(m6)(without2015)-mean(m45)(without2015)+m45(2015)
#m6diff12=mean(dmpjp[-c(1,nrow(dmpjp)),"m6"]-dmpjp[-c(1,nrow(dmpjp)),"m45"])+dmpjp[nrow(dmpjp),"m45"]

#mxdiff12=ddmpjp[which(ddmpjp$year==2014),"diff"]+dmpjp[which(dmpjp$year==2015),"m6"]
mxdiff12=ddmpjp[which(ddmpjp$year==2014),"diff"]+dmpjp[which(dmpjp$year==2015),"m6"]

predict.result=mxdiff12+dmjp[which(dmjp$year==2014),target.smon]
prange=range(dmpjp[-c(1,nrow(dmpjp)),target.smon]-dmpjp[-c(1,nrow(dmpjp)),"m6"])+dmpjp[nrow(dmpjp),"m6"]+dmjp[which(dmjp$year==2014),target.smon]
benchmark[2,]=data.frame(date=as.Date(target.time),methdology="Y2Y Diff 1st Order M6",
                         floor=prange[1],
                         cap=prange[2],
                         bestguess=predict.result,stringsAsFactors = F)


dmjp[which(dmjp$year==2015),target.smon]=predict.result
dmpjp[which(dmjp$year==2015),target.smon]=mxdiff12
#melt and paint
mdmjp=select(dmjp,year,m7,m6,m56)
mdmjp=melt(mdmjp,id="year")
mdmpjp=select(dmpjp,year,m7,m6,m56)
mdmpjp=melt(mdmpjp,id="year")
```

###2.3.2  结果

```{r, echo=FALSE,results='hide',message=FALSE,warning=FALSE, cache=F}

p <- ggplot(mdmjp, aes(year, value))
p1 <- p + geom_line(aes(colour = factor(variable)), alpha = 0.6)+geom_point(aes(colour = factor(variable)))+
  labs(title="JP History Tourist Number Prediction Groupby Month")+
  geom_text(aes(x=2015,y=max(value,na.rm=T)),hjust=1,label="Select The Largest Y2Y Increase Ever")
print(p1)

p <- ggplot(mdmpjp, aes(year, value))
p1 <- p + geom_line(aes(colour = factor(variable)), alpha = 0.6)+geom_point(aes(colour = factor(variable)))+
  labs(title="JP History Tourist Y2Y Growth Amount Prediction Groupby Month")+
  geom_text(aes(x=2015,y=max(value,na.rm=T)),hjust=1,label="Select The Largest Y2Y Increase Ever")
print(p1)



```

`r knitr::kable(benchmark[2,],caption="基于Y2Y增长绝对数值的一阶差分预测")`



##2.4  基于M2M月度一阶差分的线性回归预测

###2.4.1 方法论

+  本方法研究一阶差分Diff1，也就是M7-M6，也就是M2M月度增长量的规律

+  M2M的话月度之间相关性不强，主要看年度之间的M7-M6是否出现相关性，因此主要看groupby Year的图

+  下图1 2中，可以看到M2M一阶差分Diff(M7-M6)在各个年度还是呈现一定相关性的，特别是2014 2012 2010年度

+  M6-M5和M5-M4历年的数据也不错

```{r, echo=FALSE,results='hide',message=FALSE,warning=FALSE, cache=F}

p <- ggplot(filter(jp,year %in% c(2002:target.year),month %in% c(4:target.mon)), aes(date, diff))
#p2=p+geom_line()+labs(title="JP Tourist Number 1st order difference")
#print(p2)  
#Now let's see the diff by month 
#from this pic we can see: month 1/5/6 the y2y month diff is stable, and can use the differential methond
p1 <- p + geom_line(aes(colour = factor(month)), alpha = 0.6)+geom_point(aes(colour = factor(month)))+
  labs(title="JP 1st order difference Groupby Month")
print(p1)



#=================================================================================
# First Order with Linear Regression : M7=approximated diff1 + M6
# approximated diff1(M7-M6)=LR(M6)
p <- ggplot(filter(jp,year %in% c(2008:target.year),month %in% c(4:target.mon)), aes(month, arrival))
p1 <- p + geom_line(aes(colour = factor(year)), alpha = 0.6)+geom_point(aes(colour = factor(year)))+
  labs(title="JP Tourist Number Groupby Year")
print(p1)


vjp=dcast(meltjp,year~month+variable)
names(vjp)=c("year",paste("m",c(1:target.mon),sep=""))
vjp$m56=(vjp$m6+vjp$m5)/2

vjp=filter(vjp,year %in% c(2008:target.year))
vjp=select(vjp,year,m7,m6,m56)
vjp=transform(vjp, diff6=m7-m6, diff56=m7-m56)

cor.diff=cor(vjp$diff6,vjp[,2:ncol(vjp)],use="na.or.complete")

cor.diff=cor(vjp$diff56,vjp[,2:ncol(vjp)],use="na.or.complete")

#m56 is the best



#diff.fit=lm(diff6~m6,na.exclude(vjp))
diff.fit=lm(diff56~m56,na.exclude(vjp))

#predict(diff.fit,newdata=vjp[which(vjp$year==2015),])+vjp[which(vjp$year==2015),"m56"]
approxdiff=predict(diff.fit,newdata=vjp[which(vjp$year==2015),])
predict.result=approxdiff+vjp[which(vjp$year==2015),"m56"]
vjp$prediction=predict(diff.fit,newdata=vjp)
vjp$error=(vjp$prediction-vjp$diff56)/(vjp$m7)


```

###2.4.2 有关回归

+  通过研究发现，（M7-M6）与M56呈现强相关`r as.data.frame(cor.diff)[,"m56"]`

+  也就是说，M56（或M6）越大，（M7-M6）会越大

+  下面图1直观展示了二者的线性关系，图2展示了（M7-M6）结果，图3展示了误差情况

+  呈现强相关的都是在（M56）低位，因为2015 （M56）暴增，在高位是否与（M7-M6）仍然呈现线性关系是个问题

+  因此，本方法相对来说比较“激进”

`r knitr::kable(as.data.frame(cor.diff),caption="基于M2M月度一阶差分的线性回归预测")`

```{r, echo=FALSE,results='hide',message=FALSE,warning=FALSE, cache=F}


msjp=melt(vjp[,c("m56","diff56","prediction")],id="m56")
p <- ggplot(msjp, aes(m56, value))
p1 <- p + geom_line(aes(colour = factor(variable)), alpha = 0.6)+geom_point(aes(colour = factor(variable)))+
  labs(title="M2M Diff1 Vs M56 to Predict M7")
print(p1)

msjp=melt(vjp[,c("year","diff56","prediction")],id="year")
p <- ggplot(msjp, aes(year, value))
p1 <- p + geom_line(aes(colour = factor(variable)), alpha = 0.6)+geom_point(aes(colour = factor(variable)))+
  labs(title="M2M Diff M7-M56 to Predict M7")
print(p1)

(p <- ggplot(data=vjp,aes(x=factor(year),weight=error,fill=factor(year))) + 
  geom_bar(position='dodge')+labs(title="M2M Linear Regression Error"))

prange=range(vjp$diff56-predict(diff.fit,newdata=vjp),na.rm = T)+predict.result

benchmark[3,]=data.frame(date=as.Date(target.time),methdology="M2M 1st Order Diff LR with M56",
                         floor=prange[1],
                         cap=prange[2],
                         bestguess=predict.result,stringsAsFactors = F)


```


###2.4.3 结果

`r knitr::kable(benchmark[3,],caption="基于M2M月度一阶差分的线性回归预测")`

##2.5  基于M2M月度一阶差分的保守预测

##2.5.1 方法论

+  一阶差分保守预测，就是简单的认为M7-M6是多年保持不变的，去年M2M涨多少，今年继续涨多少。

```{r, echo=FALSE,results='hide',message=FALSE,warning=FALSE, cache=F}


#=================================================================================
# First Order without Linear Regression : M7(2015)-M6(2015)=M7(2014)-M6(2014)
# M7(2015)=M6(2015)+M7(2014)-M6(2014)
approxdiff=vjp[which(vjp$year==2014),"diff6"]
predict.result=approxdiff+vjp[which(vjp$year==2015),"m6"]

benchmark[4,]=data.frame(date=as.Date(target.time),methdology="M2M 1st Order Diff Staionary M6",
                         floor=NA,
                         cap=NA,
                         bestguess=predict.result,stringsAsFactors = F)


temp=filter(jp,year %in% c(2008:target.year),month %in% c(4:target.mon))
temp[which(temp$date==as.Date("2015-07-01")),"arrival"]=predict.result
p <- ggplot(temp, aes(month, arrival))
p1 <- p + geom_line(aes(colour = factor(year)), alpha = 0.6)+geom_point(aes(colour = factor(year)))+
  labs(title="JP Tourist Number Groupby Year")
print(p1)

```


###2.5.2 结果

`r knitr::kable(benchmark[4,],caption="基于M2M月度一阶差分的保守预测")`

    
##2.6  基于M2M月度二阶差分预测

###2.6.1 方法论

+  基于M2M月度二阶差分预测研究对象是M2M的增长量（M7-M6）的增长量，认为M2M的增长量（M7-M6）的增长量是保持不变的

+   Diff M7(2015) - Diff M6(2015)=Diff M7(2014) - Diff M6(2014)

+   Diff M7(2015)=Diff M6(2015)+Diff M7(2014)-Diff M6(2014)

```{r, echo=FALSE,results='hide',message=FALSE,warning=FALSE, cache=F}

#=================================================================================
# Second Order without Linear Regression : Diff M7(2015) - Diff M6(2015)=Diff M7(2014) - Diff M6(2014)
# M7(2015)=M6(2015)+M7(2014)-M6(2014)

# Second Order
p <- ggplot(filter(jp,year %in% c(2008:target.year),month %in% c(4:target.mon)), aes(month, diff))
p1 <- p + geom_line(aes(colour = factor(year)), alpha = 0.6)+geom_point(aes(colour = factor(year)))+
  labs(title="JP 1st order difference Groupby Year")
print(p1)

diff1=select(filter(jp,year %in% c(2004:target.year),month %in% c(1:target.mon)),year,month,diff)
diff1=melt(diff1,id=c("year","month"))
diff1=dcast(diff1,year~month+variable)
names(diff1)=c("year",paste("m",c(1:target.mon),sep=""))

approxdiff=diff1[which(diff1$year==2015),"m6"]+diff1[which(diff1$year==2014),"m7"]-diff1[which(diff1$year==2014),"m6"]
predict.result=approxdiff+vjp[which(vjp$year==2015),"m6"]

benchmark[5,]=data.frame(date=as.Date(target.time),methdology="M2M 2nd Order Diff with M6",
                         floor=NA,
                         cap=NA,
                         bestguess=predict.result,stringsAsFactors = F)

temp=filter(jp,year %in% c(2008:target.year),month %in% c(4:target.mon))
temp[which(temp$date==as.Date("2015-07-01")),"diff"]=approxdiff
p <- ggplot(temp, aes(month, diff))
p1 <- p + geom_line(aes(colour = factor(year)), alpha = 0.6)+geom_point(aes(colour = factor(year)))+
  labs(title="JP 2st order difference Groupby Year")
print(p1)


```


###2.6.3 结果

`r knitr::kable(benchmark[5,],caption="基于M2M月度二阶差分预测")`

    
##2.7  基于百度指数的线性回归预测

###2.7.1 方法论

+  因变量：

    +  在所有的百度指数中，寻找2014年以来，与日本旅游人数相关性最强的关键词作为预测依据

+  哑变量：

    +  newyear：用来解决新年在1月还是2月的问题
    
    +  mars：用来解决韩国旅游人数在6月份暴跌，日本暴涨的问题
    

```{r, echo=FALSE,results='hide',message=FALSE,warning=FALSE, cache=F}


#=================================================================================================
#6 predict with linear regression method

#5.1 read the data of baidu index----------------------------------------
hotword=read.xlsx("japan-hotword.xlsx",1)
hotword=hotword[order(hotword$date),]
hwname=c("date","qz","ly","y","tq","jd","ryfy","hl","lyqz","jg","dt","lygl","yh","zyx","gwgl","gw","lyjd",
         "ctjc","djdt","csly","cslygl","dj","bhd","db","jingdu","mgw","fg","zhahuang","nailiang","hengbin","fss","chongsheng","xianggen","segu")
names(hotword)=hwname

#turn off the data to numeric
for (i in 2:ncol(hotword)){
  for (j in 1:nrow(hotword)){
    if (hotword[j,i]<(mean(hotword[,i])/100)){
      cat(i,j,hotword[j,i],mean(hotword[,i]),hotword[j-1,i],"\n")
      hotword[j,i]=hotword[j-1,i]
    }
  }
  #cat(mean(index[,i]))
}

hotword$sp=rowSums(hotword[,which(names(hotword)=="ctjc"):which(names(hotword)=="segu")])
hotword$sumall=rowSums(hotword[,c("lyqz","ly","jd","jg","hl","dt","lygl","yh","zyx","gwgl","gw","sp")])

fhw=hotword[,-(which(names(hotword)=="ctjc"):which(names(hotword)=="segu"))]
names(fhw)=c("date","qz","ly","y","tq","jd","ryfy","hl","lyqz","jg","dt","lygl","yh","zyx","gwgl","gw","lyjd","sp","sumall")
fhw=transform(fhw,month=format(date,"%Y-%m"))

fhw.melt=melt(fhw,id=c("date","month"))
fhw.gb=group_by(fhw.melt,month,variable)
fhw.month=summarize(fhw.gb,date=first(date),value=sum(value))
fhw.month=dcast(fhw.month,date+month~variable)


begindate=as.Date("2013-01-01")
enddate=as.Date(target.time)
lag=0

fhw.month=filter(fhw.month,date %in% c(begindate:enddate))
date=fhw.month$date

#5.2 hwm----------------------------------------------------------------hwm

hwm=select(fhw.month,date,month,jd,jg,gwgl,ly,lyqz,lygl,zyx,sp,sumall)
hwm.lag=select(fhw.month,jd,jg,gwgl,ly,lyqz,lygl,zyx,sp,sumall)
hwm.lag[2:(nrow(fhw.month)),]=hwm.lag[1:(nrow(fhw.month)-1),]
hwm.lag[1,]=NA
names(hwm.lag)=c("jd1","jg1","gwgl1","ly1","lyqz1","lygl1","zyx1","sp1","sumall1")
#hwm=transform(hwm,ly1=c(NA,fhw.month[1:nrow(fhw.month)-1,"ly"]),lyqz1=c(NA,fhw.month[1:nrow(fhw.month)-1,"lyqz"]),
#              lygl1=c(NA,fhw.month[1:nrow(fhw.month)-1,"lygl"]),zyx1=c(NA,fhw.month[1:nrow(fhw.month)-1,"zyx"]))
hwm=cbind(hwm,hwm.lag)

hwm=transform(hwm,
              arrival=jp[which(jp$date==first(date)):which(jp$date==last(date)),"arrival"],
              arrival1=jp[which(jp$date==first(date)):which(jp$date==last(date)),"arrival1"],
              arrival12=jp[which(jp$date==first(date)):which(jp$date==last(date)),"arrival12"],
              korea=jp[which(jp$date==first(date)):which(jp$date==last(date)),"korea"],
              holiday=jp[which(jp$date==first(date)):which(jp$date==last(date)),"holiday"],
              nbmonth=jp[which(jp$date==first(date)):which(jp$date==last(date)),"nbmonth"],
              newyear=jp[which(jp$date==first(date)):which(jp$date==last(date)),"newyear"])
hwm$mars=0
#201506-201507
mars.mon=c(as.Date("20150601",format="%Y%m%d"),as.Date("20150701",format="%Y%m%d"))
hwm[which(hwm$date %in% mars.mon),"mars"]=1

              

#5.3 hwm.t--------------------------------------------------------------hwm.t
#For Linear regression, we should determine some really important assumption 
#1st: the time time range, 2014 tillnow,or 2015 tillnow, or the specific month
#2nd: the variables, e.g. lygl1 zyx1  jg newyear

predict.no=1
usefuldate=hwm[which(hwm$date==as.Date("2014-01-01")):which(hwm$date==as.Date("2015-07-01")),"date"]
hwm.p=hwm[which(hwm$date==as.Date("2015-07-01")):which(hwm$date==as.Date("2015-07-01")),]

# choose the best time interval  for  linear regression
location=c(which(names(hwm)=="jd"):which(names(hwm)=="korea"))
time.all=c(which(hwm$date==as.Date("2014-01-01")):which(hwm$date==as.Date("2015-06-01")))
time.2014=c(which(hwm$date==as.Date("2014-01-01")):which(hwm$date==as.Date("2014-06-01")))
time.2015=c(which(hwm$date==as.Date("2015-01-01")):which(hwm$date==as.Date("2015-06-01")))
time.interval=c(time.2014,time.2015)
time.range=time.interval
cor.interval=as.data.frame(cor(hwm[time.interval,"arrival"],hwm[time.interval,location],use="na.or.complete"))
cor.interval[,order(-cor.interval)]
cor.interval=as.data.frame(cor(hwm[time.all,"arrival"],hwm[time.all,location],use="na.or.complete"))
cor.interval[,order(-cor.interval)]


#interval: for 201506 we use 2014 2015 1-5month
#---------------------------------------------------------------------------
#************determine the interval ****************************************
#---------------------------------------------------------------------------
time.range=time.all
#time.range=time.all
cat("The Date We Use in this algorithm\n", as.character(hwm[time.range,"date"]),"\n")
hwm.t=hwm[time.range,]


cat("The correlation of the hotwords we may select:\n")
hwm.cor=as.data.frame(cor(hwm.t$arrival,hwm.t[,location]),use="na.or.complete")
hwm.cor[order(-hwm.cor)]
names(hwm.t[,location])[order(-hwm.cor)]


hwfit=lm(arrival~gwgl+newyear+mars,hwm.t)# 40.1

mse=sum(((fitted(hwfit)-hwm.t$arrival)/hwm.t$arrival)^2)^(1/2)
error=(fitted(hwfit)-hwm.t$arrival)/hwm.t$arrival
hwm.t$predict=fitted(hwfit)
hwm.t$error=error
#barplot(error,names.arg=hwm.t$date,ylab="ERROR")
(p <- ggplot(data=hwm.t,aes(x=factor(month),weight=error,fill=factor(month))) + geom_bar(position='dodge')+labs(title="Linear Regression Error"))



#3.2 predict-----------------------------------------------------------predict
hwm.p$arrival=predict(hwfit,newdata=hwm.p)
hwm[(nrow(hwm)-predict.no+1):nrow(hwm),]=hwm.p
hwm[(nrow(hwm)-predict.no+1):nrow(hwm),]=hwm.p
cat("the predicted final value: ",as.character(hwm.p$date), hwm.p$arrival,"\n")


msjp=hwm
msjp$prediction=predict(hwfit,newdata=msjp)
msjp=melt(msjp[,c("date","arrival","prediction")],id="date")
p <- ggplot(msjp, aes(date, value))
p1 <- p + geom_line(aes(colour = factor(variable)), alpha = 0.6)+geom_point(aes(colour = factor(variable)))+
  labs(title="LR Prediction Vs Official")
print(p1)

#3.3 evalation--------------------------------------------------------evaluation

predict.result=predict(hwfit,newdata=hwm.p)


benchmark[6,]=data.frame(date=as.Date(target.time),methdology="LR with gwgl mars",
                         floor=NA,
                         cap=NA,
                         bestguess=predict.result,stringsAsFactors = F)

benchmark[7,]=data.frame(date=as.Date(target.time),methdology="Method Mean",
                         floor=NA,
                         cap=NA,
                         bestguess=mean(benchmark[1:6,"bestguess"]),stringsAsFactors = F)
```

###2.7.2 结果

`r knitr::kable(benchmark[6,],caption="基于百度指数的线性回归预测")`


# 3 仿真结果





```{r, echo=FALSE,results='hide',message=FALSE,warning=FALSE, cache=F}
#final.result=benchmark[7,"bestguess"]
(final.result=mean(benchmark[c(1,2,3,5),"bestguess"]))

row.names(benchmark)=as.character(1:7)
benchmark[8,]=data.frame(date=as.Date(target.time),methdology="Final Result",
                         floor=NA,
                         cap=NA,
                         bestguess=final.result,stringsAsFactors = F)



jp[which(jp$date==as.Date(target.time)),"arrival"]=final.result
jp[which(jp$date==as.Date(target.time)),]=transform(jp[which(jp$date==as.Date(target.time)),],
                                                    diff=arrival-arrival1,diff12=arrival-arrival12,
                                                    mm=arrival/arrival1,yy=arrival/arrival12)
tjp=tail(select(jp,date,thismon=arrival,lastmon=arrival1,lastyear=arrival12,M2M=diff,Y2Y=diff12,mm,yy,korea),13)
names(tjp)=c("date",paste(target.year,target.mon,sep="-"),paste(target.year,target.mon-1,sep="-"),paste(target.year-1,target.mon,sep="-"), "M2M", "Y2Y","mmratio","yyratio","korea")

knitr::kable(benchmark,caption="最终预测结果汇总表")
knitr::kable(tjp,caption=paste(as.Date(target.time),"Result Analysis"))

```

`r knitr::kable(benchmark,caption="最终预测结果汇总表")`
`r knitr::kable(tjp,caption=paste(as.Date(target.time),"Result Analysis"))`

```{r, echo=FALSE,results='hide',message=FALSE,warning=FALSE, cache=F}
#---------------------------------------overview--------------------------------------------
p <- ggplot(jp, aes(month, arrival))
p1 <- p + geom_line(aes(colour = factor(year)), alpha = 0.6) + 
  geom_point(aes(colour = factor(year)))+labs(title="JP History Overview Groupby Year")
print(p1)
p2=p + geom_line(aes(colour = factor(year)), alpha = 0.6)+geom_point(aes(colour = factor(year)))+facet_wrap(~year)+
  labs(title="JP History Tourist Number Overview")
print(p2)

#---------------------------------------Y2Y group by month--------------------------------------------
p<- ggplot(filter(jp,year %in% c(2002:target.year),month %in% c(4:target.mon)), aes(year, arrival))
p1 <- p + geom_line(aes(colour = factor(month)), alpha = 0.6)+geom_point(aes(colour = factor(month)))+
  labs(title="JP History Tourist Number Groupby Month")
print(p1)

p<- ggplot(filter(jp,year %in% c(2002:target.year),month %in% c(4:target.mon)), aes(year, diff12))
p1 <- p + geom_line(aes(colour = factor(month)), alpha = 0.6)+geom_point(aes(colour = factor(month)))+
  labs(title="JP Y2Y Diff Groupby Month")
print(p1)



#---------------------------------------M2M group by year--------------------------------------------
p <- ggplot(filter(jp,year %in% c(2008:target.year),month %in% c(4:target.mon)), aes(month, arrival))
p1 <- p + geom_line(aes(colour = factor(year)), alpha = 0.6)+geom_point(aes(colour = factor(year)))+
  labs(title="JP Tourist Number Groupby Year")
print(p1)

p <- ggplot(filter(jp,year %in% c(2008:target.year),month %in% c(4:target.mon)), aes(month, diff))
p1 <- p + geom_line(aes(colour = factor(year)), alpha = 0.6)+geom_point(aes(colour = factor(year)))+
  labs(title="JP M2M Groupby Year")
print(p1)








```

